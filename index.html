<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Group Chat • WhatsApp Style with Firebase</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <!-- Emoji Picker CDN -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/emoji-picker-element@1/index.css">
  <style>
    :root {
      --primary: #25D366;
      --primary-dark: #128C7E;
      --bg: #E5DDD5;
      --chat-bg: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
      --msg-bg: #DCF8C6;
      --msg-bg-incoming: #FFFFFF;
      --msg-bg-admin: #FFEFD5; /* Special for admin */
      --text: #111;
      --time: #666;
      --border: #ddd;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
      background: var(--bg);
      height: 100vh;
      overflow: hidden;
      background-image: var(--chat-bg);
      background-repeat: repeat;
      background-position: center;
      color: var(--text);
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .header {
      background: var(--primary);
      color: white;
      padding: 12px 16px;
      display: flex;
      align-items: center;
      gap: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      position: relative;
      z-index: 10;
    }

    .header .back {
      font-size: 1.4rem;
      cursor: pointer;
    }

    .header .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #075E54;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 1.1rem;
    }

    .header .info {
      flex: 1;
    }

    .header h2 {
      font-size: 1.1rem;
      margin-bottom: 3px;
    }

    .header p {
      font-size: 0.8rem;
      opacity: 0.9;
    }

    .chat-area {
      flex: 1;
      overflow-y: auto;
      padding: 20px 12px;
      background: transparent;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .message {
      max-width: 75%;
      margin-bottom: 6px;
      position: relative;
      display: flex;
      flex-direction: column;
    }

    .message.outgoing {
      align-self: flex-end;
    }

    .message.incoming {
      align-self: flex-start;
    }

    .message.admin {
      align-self: center;
      max-width: 90%;
    }

    .bubble {
      padding: 8px 12px;
      border-radius: 7.5px;
      line-height: 1.4;
      position: relative;
      font-size: 0.95rem;
    }

    .bubble.outgoing {
      background: var(--msg-bg);
      border-bottom-right-radius: 2px;
    }

    .bubble.incoming {
      background: var(--msg-bg-incoming);
      border-bottom-left-radius: 2px;
    }

    .bubble.admin {
      background: var(--msg-bg-admin);
      border-radius: 7.5px;
      text-align: center;
    }

    .bubble img {
      max-width: 300px;
      border-radius: 7.5px;
    }

    .time {
      font-size: 0.68rem;
      color: var(--time);
      margin-top: 3px;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 4px;
    }

    .ticks {
      font-size: 0.8rem;
      color: #53bdeb; /* Blue for read */
    }

    .name {
      font-weight: 600;
      font-size: 0.85rem;
      margin-bottom: 4px;
      color: #006a4e;
      display: block;
    }

    .delete-btn {
      cursor: pointer;
      color: #999;
      font-size: 0.8rem;
      margin-left: 8px;
      visibility: hidden;
    }

    .message:hover .delete-btn {
      visibility: visible;
    }

    .input-area {
      background: #F0F0F0;
      padding: 10px 12px;
      display: flex;
      align-items: center;
      gap: 8px;
      border-top: 1px solid var(--border);
      position: relative;
    }

    .input-area input[type="text"] {
      flex: 1;
      padding: 12px 16px;
      border: none;
      border-radius: 25px;
      background: white;
      font-size: 0.95rem;
      outline: none;
    }

    .input-area input[type="file"] {
      display: none;
    }

    .emoji-btn, .image-btn {
      background: none;
      border: none;
      font-size: 1.2rem;
      cursor: pointer;
      color: #666;
    }

    .input-area button {
      width: 42px;
      height: 42px;
      border-radius: 50%;
      border: none;
      background: var(--primary);
      color: white;
      font-size: 1.2rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .input-area button:hover {
      background: var(--primary-dark);
    }

    .emoji-picker {
      position: absolute;
      bottom: 60px;
      left: 10px;
      z-index: 100;
      display: none;
    }

    .emoji-picker.show {
      display: block;
    }

    .status {
      text-align: center;
      font-size: 0.8rem;
      color: #555;
      padding: 8px;
      background: rgba(255,255,255,0.6);
      margin: 10px auto;
      border-radius: 8px;
      max-width: 220px;
    }

    @media (max-width: 500px) {
      .container {
        max-width: 100%;
      }
      .header {
        padding: 10px 14px;
      }
      .chat-area {
        padding: 16px 10px;
      }
    }
  </style>
</head>
<body>

<div class="container">
  <div class="header">
    <div class="back"><i class="fas fa-arrow-left"></i></div>
    <div class="avatar">TM</div>
    <div class="info">
      <h2>TeachMore Group</h2>
      <p>42 participants • active now</p>
    </div>
  </div>

  <div class="chat-area" id="chatArea">
    <div class="status">Messages are end-to-end encrypted. No one outside this chat, not even TeachMore, can read or listen to them.</div>
  </div>

  <div class="input-area">
    <button class="emoji-btn" id="emojiBtn"><i class="fas fa-smile"></i></button>
    <button class="image-btn" id="imageBtn"><i class="fas fa-image"></i></button>
    <input type="text" id="messageInput" placeholder="Type a message..." autocomplete="off"/>
    <input type="file" id="imageInput" accept="image/*"/>
    <button id="sendBtn"><i class="fas fa-paper-plane"></i></button>
    <div class="emoji-picker" id="emojiPicker"></div>
  </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage.js"></script>

<!-- Emoji Picker JS -->
<script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@1/index.js"></script>

<script>
  // Firebase Configuration - Replace with your own from Firebase Console
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
    databaseURL: "https://YOUR_PROJECT_ID-default-rtdb.firebaseio.com",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_PROJECT_ID.appspot.com",
    messagingSenderId: "YOUR_SENDER_ID",
    appId: "YOUR_APP_ID"
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const database = firebase.database();
  const auth = firebase.auth();
  const storage = firebase.storage();

  const chatArea = document.getElementById('chatArea');
  const messageInput = document.getElementById('messageInput');
  const sendBtn = document.getElementById('sendBtn');
  const emojiBtn = document.getElementById('emojiBtn');
  const emojiPicker = document.getElementById('emojiPicker');
  const imageBtn = document.getElementById('imageBtn');
  const imageInput = document.getElementById('imageInput');

  // Create emoji picker element
  const picker = document.createElement('emoji-picker');
  emojiPicker.appendChild(picker);

  // Toggle emoji picker
  emojiBtn.addEventListener('click', () => {
    emojiPicker.classList.toggle('show');
  });

  // Insert emoji into input
  picker.addEventListener('emoji-click', event => {
    messageInput.value += event.detail.unicode;
    messageInput.focus();
  });

  let userName = prompt('Enter your name:');
  if (!userName) userName = 'Guest';
  const isAdmin = userName.toLowerCase() === 'admin'; // Note: Insecure; for demo only. In prod, use auth claims.

  let currentUser;

  // Anonymous auth
  auth.signInAnonymously()
    .then(userCredential => {
      currentUser = userCredential.user;
      loadMessages();
    })
    .catch(error => console.error('Auth error:', error));

  function loadMessages() {
    database.ref('messages').orderByChild('timestamp').limitToLast(50).on('child_added', snapshot => {
      const msg = snapshot.val();
      addMessage(snapshot.key, msg.type || 'text', msg.text || msg.url, msg.sender === userName, msg.sender, msg.readBy || [], msg.sender === 'Admin');
      
      // Mark as read if not already
      if (msg.sender !== userName && !msg.readBy?.includes(currentUser.uid)) {
        database.ref(`messages/${snapshot.key}/readBy`).push(currentUser.uid);
      }
    });

    database.ref('messages').on('child_changed', snapshot => {
      // Update message UI for readBy changes (ticks)
      const msgDiv = document.querySelector(`[data-key="${snapshot.key}"]`);
      if (msgDiv) {
        const timeSpan = msgDiv.querySelector('.time');
        const msg = snapshot.val();
        const isOutgoing = msg.sender === userName;
        if (isOutgoing) {
          timeSpan.innerHTML = `\( {getCurrentTime(msg.timestamp)} <span class="ticks"> \){getTicks(msg.readBy?.length || 0)}</span>`;
        }
      }
    });

    database.ref('messages').on('child_removed', snapshot => {
      const msgDiv = document.querySelector(`[data-key="${snapshot.key}"]`);
      if (msgDiv) msgDiv.remove();
    });
  }

  function addMessage(key, type, content, isOutgoing, name, readBy, isAdminMsg) {
    const msgDiv = document.createElement('div');
    msgDiv.classList.add('message');
    msgDiv.dataset.key = key;
    if (isOutgoing) {
      msgDiv.classList.add('outgoing');
    } else {
      msgDiv.classList.add('incoming');
    }
    if (isAdminMsg) {
      msgDiv.classList.add('admin');
    }

    let html = '';
    if (!isOutgoing && name && !isAdminMsg) {
      html += `<span class="name">${name}</span>`;
    }
    if (type === 'image') {
      html += `<div class="bubble ${isOutgoing ? 'outgoing' : 'incoming'} \( {isAdminMsg ? 'admin' : ''}"><img src=" \){content}" alt="Uploaded image"/></div>`;
    } else {
      html += `<div class="bubble ${isOutgoing ? 'outgoing' : 'incoming'} \( {isAdminMsg ? 'admin' : ''}"> \){content}</div>`;
    }
    html += `<span class="time">${getCurrentTime()} `;
    if (isOutgoing) {
      html += `<span class="ticks">${getTicks(readBy.length)}</span>`;
    }
    html += `</span>`;

    if (isOutgoing || isAdmin) {
      html += `<i class="fas fa-trash delete-btn" onclick="deleteMessage('\( {key}', ' \){name}')"></i>`;
    }

    msgDiv.innerHTML = html;
    chatArea.appendChild(msgDiv);
    chatArea.scrollTop = chatArea.scrollHeight;
  }

  function getCurrentTime(timestamp = Date.now()) {
    const now = new Date(timestamp);
    return now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
  }

  function getTicks(readCount) {
    if (readCount > 0) {
      return '<i class="fas fa-check-double" style="color: #53bdeb;"></i>'; // Blue double if read by at least one
    } else {
      return '<i class="fas fa-check-double"></i>'; // Gray double (delivered)
    }
    // Single tick not shown after delivered; assume delivered once in DB
  }

  sendBtn.addEventListener('click', sendMessage);
  messageInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      sendMessage();
    }
  });

  function sendMessage() {
    const text = messageInput.value.trim();
    if (!text) return;

    const msg = {
      type: 'text',
      text,
      sender: userName,
      timestamp: Date.now(),
      readBy: []
    };

    messageInput.value = '';
    emojiPicker.classList.remove('show');

    // Push to Firebase
    database.ref('messages').push(msg);
  }

  // Image upload
  imageBtn.addEventListener('click', () => {
    imageInput.click();
  });

  imageInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const storageRef = storage.ref('images/' + file.name);
    storageRef.put(file).then(snapshot => {
      snapshot.ref.getDownloadURL().then(url => {
        const msg = {
          type: 'image',
          url,
          sender: userName,
          timestamp: Date.now(),
          readBy: []
        };
        database.ref('messages').push(msg);
      });
    });
  });

  window.deleteMessage = function(key, senderName) {
    if (confirm('Delete this message?')) {
      if (userName === senderName || isAdmin) {
        database.ref('messages/' + key).remove();
      } else {
        alert('You can only delete your own messages.');
      }
    }
  }

  // Focus input
  messageInput.focus();
</script>

</body>
</html>
