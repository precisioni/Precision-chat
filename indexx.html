<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Group Chat • TeachMore</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/emoji-picker-element@1/index.css">
  <style>
    :root {
      --primary: #25D366;
      --primary-dark: #128C7E;
      --bg: #E5DDD5;
      --chat-bg: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
      --msg-bg: #DCF8C6;
      --msg-bg-incoming: #FFFFFF;
      --msg-bg-admin: #FFEFD5;
      --text: #111;
      --time: #666;
      --border: #ddd;
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: var(--bg);
      background-image: var(--chat-bg);
      background-repeat: repeat;
      height: 100vh;
      overflow: hidden;
      color: var(--text);
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .header {
      background: var(--primary);
      color: white;
      padding: 12px 16px;
      display: flex;
      align-items: center;
      gap: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .header .back { font-size: 1.4rem; cursor: pointer; }
    .header .avatar {
      width: 40px; height: 40px;
      border-radius: 50%;
      background: #075E54;
      display: flex; align-items: center; justify-content: center;
      font-weight: bold; font-size: 1.1rem;
    }
    .header .info { flex: 1; }
    .header h2 { font-size: 1.1rem; margin-bottom: 3px; }
    .header p { font-size: 0.8rem; opacity: 0.9; }
    .chat-area {
      flex: 1;
      overflow-y: auto;
      padding: 20px 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .message {
      max-width: 75%;
      margin-bottom: 6px;
      position: relative;
      display: flex;
      flex-direction: column;
    }
    .message.outgoing { align-self: flex-end; }
    .message.incoming { align-self: flex-start; }
    .message.admin { align-self: center; max-width: 90%; }
    .bubble {
      padding: 8px 12px;
      border-radius: 7.5px;
      line-height: 1.4;
      font-size: 0.95rem;
      position: relative;
    }
    .bubble.outgoing {
      background: var(--msg-bg);
      border-bottom-right-radius: 2px;
    }
    .bubble.incoming {
      background: var(--msg-bg-incoming);
      border-bottom-left-radius: 2px;
    }
    .bubble.admin {
      background: var(--msg-bg-admin);
      border-radius: 7.5px;
      text-align: center;
    }
    .bubble img {
      max-width: 300px;
      border-radius: 7.5px;
      display: block;
    }
    .time {
      font-size: 0.68rem;
      color: var(--time);
      margin-top: 3px;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 4px;
    }
    .ticks { font-size: 0.8rem; color: #53bdeb; }
    .name {
      font-weight: 600;
      font-size: 0.85rem;
      margin-bottom: 4px;
      color: #006a4e;
      display: block;
    }
    .delete-btn {
      cursor: pointer;
      color: #999;
      font-size: 0.8rem;
      margin-left: 8px;
      visibility: hidden;
    }
    .message:hover .delete-btn { visibility: visible; }
    .input-area {
      background: #F0F0F0;
      padding: 10px 12px;
      display: flex;
      align-items: center;
      gap: 8px;
      border-top: 1px solid var(--border);
    }
    .input-area input[type="text"] {
      flex: 1;
      padding: 12px 16px;
      border: none;
      border-radius: 25px;
      background: white;
      font-size: 0.95rem;
      outline: none;
    }
    .input-area input[type="file"] { display: none; }
    .emoji-btn, .image-btn {
      background: none;
      border: none;
      font-size: 1.2rem;
      cursor: pointer;
      color: #666;
    }
    .input-area button {
      width: 42px; height: 42px;
      border-radius: 50%;
      border: none;
      background: var(--primary);
      color: white;
      font-size: 1.2rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .input-area button:hover { background: var(--primary-dark); }
    .emoji-picker {
      position: absolute;
      bottom: 70px;
      left: 10px;
      z-index: 100;
      display: none;
    }
    .emoji-picker.show { display: block; }
    .status {
      text-align: center;
      font-size: 0.8rem;
      color: #555;
      padding: 8px;
      background: rgba(255,255,255,0.6);
      margin: 10px auto;
      border-radius: 8px;
      max-width: 220px;
    }
    @media (max-width: 500px) {
      .container { max-width: 100%; }
      .header { padding: 10px 14px; }
      .chat-area { padding: 16px 10px; }
    }
  </style>
</head>
<body>

<div class="container">
  <div class="header">
    <div class="back"><i class="fas fa-arrow-left"></i></div>
    <div class="avatar">TM</div>
    <div class="info">
      <h2>TeachMore Group</h2>
      <p>Participants • active now</p>
    </div>
  </div>

  <div class="chat-area" id="chatArea">
    <div class="status">Messages are end-to-end encrypted. TeachMore cannot read them.</div>
  </div>

  <div class="input-area">
    <button class="emoji-btn" id="emojiBtn"><i class="fas fa-smile"></i></button>
    <button class="image-btn" id="imageBtn"><i class="fas fa-image"></i></button>
    <input type="text" id="messageInput" placeholder="Type a message..." autocomplete="off"/>
    <input type="file" id="imageInput" accept="image/*"/>
    <button id="sendBtn"><i class="fas fa-paper-plane"></i></button>
    <div class="emoji-picker" id="emojiPicker"></div>
  </div>
</div>

<!-- Firebase (use latest compatible version or your own config) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@1/index.js"></script>

<script>
// ────────────────────────────────────────────────
//  REPLACE WITH YOUR OWN FIREBASE CONFIG
// ────────────────────────────────────────────────
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyDrHjrAfOd0YVFxy9-PTXX2DJ-MeerqS7Q",
  authDomain: "teach-more.firebaseapp.com",
  databaseURL: "https://teach-more-default-rtdb.firebaseio.com",
  projectId: "teach-more",
  storageBucket: "teach-more.firebasestorage.app",
  messagingSenderId: "199102894627",
  appId: "1:199102894627:web:f518551905763d01651796",
  measurementId: "G-JG8YL4WZJR"
};

firebase.initializeApp(firebaseConfig);
const database = firebase.database();
const auth = firebase.auth();
const storage = firebase.storage();

const chatArea = document.getElementById('chatArea');
const messageInput = document.getElementById('messageInput');
const sendBtn = document.getElementById('sendBtn');
const emojiBtn = document.getElementById('emojiBtn');
const emojiPicker = document.getElementById('emojiPicker');
const imageBtn = document.getElementById('imageBtn');
const imageInput = document.getElementById('imageInput');

// Emoji picker
const picker = document.createElement('emoji-picker');
emojiPicker.appendChild(picker);

emojiBtn.addEventListener('click', () => {
  emojiPicker.classList.toggle('show');
});

picker.addEventListener('emoji-click', e => {
  messageInput.value += e.detail.unicode;
  messageInput.focus();
});

// ────────────────────────────────────────────────
//  Simple name + admin check (demo only – not secure)
// ────────────────────────────────────────────────
let userName = prompt('Enter your display name:')?.trim() || 'Guest';
const ADMIN_PASSWORD = "teachmore2025"; // ← CHANGE THIS
let isAdmin = false;

const adminAttempt = prompt('Admin password (leave blank if not admin):')?.trim();
if (adminAttempt === ADMIN_PASSWORD) {
  isAdmin = true;
  userName = "Admin";
}

let currentUser;

// Anonymous login
auth.signInAnonymously()
  .then(cred => {
    currentUser = cred.user;
    loadMessages();
  })
  .catch(err => console.error(err));

// ────────────────────────────────────────────────
function loadMessages() {
  database.ref('messages')
    .orderByChild('timestamp')
    .limitToLast(80)
    .on('child_added', snapshot => {
      const msg = snapshot.val();
      const isOutgoing = msg.sender === userName;
      const isAdminMsg = msg.sender?.toLowerCase() === 'admin';

      addMessage(
        snapshot.key,
        msg.type || 'text',
        msg.text || msg.url || '',
        isOutgoing,
        msg.sender,
        msg.readBy || [],
        isAdminMsg
      );

      // Mark as read
      if (!isOutgoing && !msg.readBy?.includes(currentUser.uid)) {
        database.ref(`messages/${snapshot.key}/readBy`).push(currentUser.uid);
      }
    });

  // Update read receipts
  database.ref('messages').on('child_changed', snapshot => {
    const msgDiv = document.querySelector(`[data-key="${snapshot.key}"]`);
    if (!msgDiv) return;
    const msg = snapshot.val();
    if (msg.sender === userName) {
      const timeEl = msgDiv.querySelector('.time');
      if (timeEl) {
        timeEl.innerHTML = `\( {getTime(msg.timestamp)} <span class="ticks"> \){getTicks(msg.readBy?.length || 0)}</span>`;
      }
    }
  });

  database.ref('messages').on('child_removed', snapshot => {
    document.querySelector(`[data-key="${snapshot.key}"]`)?.remove();
  });
}

function addMessage(key, type, content, isOutgoing, sender, readBy, isAdminMsg) {
  const div = document.createElement('div');
  div.classList.add('message');
  div.dataset.key = key;

  if (isAdminMsg) div.classList.add('admin');
  else if (isOutgoing) div.classList.add('outgoing');
  else div.classList.add('incoming');

  let html = '';
  if (!isOutgoing && sender && !isAdminMsg) {
    html += `<span class="name">${sender}</span>`;
  }

  const bubbleClass = `bubble \( {isOutgoing?'outgoing':'incoming'} \){isAdminMsg?' admin':''}`;

  if (type === 'image') {
    html += `<div class="\( {bubbleClass}"><img src=" \){content}" alt="image"/></div>`;
  } else {
    html += `<div class="\( {bubbleClass}"> \){content}</div>`;
  }

  html += `<span class="time">${getTime()} `;
  if (isOutgoing) html += `<span class="ticks">${getTicks(readBy.length)}</span>`;
  html += `</span>`;

  if (isOutgoing || isAdmin) {
    html += `<i class="fas fa-trash delete-btn" onclick="deleteMessage('\( {key}',' \){sender.replace(/'/g,"\\'")}')"></i>`;
  }

  div.innerHTML = html;
  chatArea.appendChild(div);
  chatArea.scrollTop = chatArea.scrollHeight;
}

function getTime(ts = Date.now()) {
  return new Date(ts).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
}

function getTicks(count) {
  return count > 0
    ? '<i class="fas fa-check-double" style="color:#53bdeb;"></i>'
    : '<i class="fas fa-check-double"></i>';
}

function sendMessage() {
  const text = messageInput.value.trim();
  if (!text) return;

  database.ref('messages').push({
    type: 'text',
    text,
    sender: userName,
    timestamp: Date.now(),
    readBy: []
  });

  messageInput.value = '';
  emojiPicker.classList.remove('show');
}

sendBtn.addEventListener('click', sendMessage);
messageInput.addEventListener('keypress', e => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
});

// Image upload
imageBtn.onclick = () => imageInput.click();

imageInput.onchange = e => {
  const file = e.target.files[0];
  if (!file) return;

  const ref = storage.ref('chat-images/' + Date.now() + '_' + file.name);
  ref.put(file).then(snap => {
    snap.ref.getDownloadURL().then(url => {
      database.ref('messages').push({
        type: 'image',
        url,
        sender: userName,
        timestamp: Date.now(),
        readBy: []
      });
    });
  }).catch(err => alert('Upload failed: ' + err.message));
};

window.deleteMessage = (key, sender) => {
  if (!confirm('Delete this message?')) return;
  if (userName === sender || isAdmin) {
    database.ref('messages/' + key).remove();
  } else {
    alert("You can only delete your own messages (or you are not admin).");
  }
};

messageInput.focus();
</script>
</body>
</html>
